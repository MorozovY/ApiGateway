# GitLab CI/CD Pipeline для ApiGateway
# Story 13.1: GitHub Mirror sync
# Story 13.2+: Build, test, deploy stages будут добавлены позже

stages:
  - sync

# Синхронизация в GitHub (manual trigger)
# Запускается только вручную после merge в main
sync-to-github:
  stage: sync
  image: alpine:latest
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true
  script:
    - apk add --no-cache git
    - git config --global user.email "ci@localhost"
    - git config --global user.name "GitLab CI"
    - git remote add github https://oauth2:${GITHUB_TOKEN}@github.com/MorozovY/ApiGateway.git || true
    - git fetch --unshallow || true
    - git push github HEAD:master --force
    - git push github --tags --force
  tags:
    - docker
