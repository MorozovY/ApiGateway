# GitLab CI/CD Pipeline для ApiGateway
# Story 13.1: GitHub Mirror sync
# Story 13.2: Build, test stages

stages:
  - build
  - test
  - sync

# =============================================================================
# CACHE TEMPLATES
# =============================================================================

# Gradle cache template для backend jobs
# ВАЖНО: Кэшируем только wrapper и dependencies, не build outputs
.gradle-cache:
  cache:
    key: gradle-deps-v1
    paths:
      - backend/.gradle/wrapper/
      - backend/.gradle/caches/
    policy: pull-push

# NPM cache template для frontend jobs
.npm-cache:
  cache:
    key: npm-${CI_COMMIT_REF_SLUG}
    paths:
      - frontend/admin-ui/node_modules/
    policy: pull-push

# =============================================================================
# BUILD STAGE
# =============================================================================

backend-build:
  stage: build
  image: eclipse-temurin:21-jdk
  extends: .gradle-cache
  timeout: 15 minutes
  script:
    - chmod +x backend/gradlew
    - cd backend
    # --no-build-cache для избежания проблем с испорченным cache
    - ./gradlew build -x test --no-build-cache
  # Artifacts не сохраняем - test job сам компилирует код
  tags:
    - docker

frontend-build:
  stage: build
  image: node:20-alpine
  extends: .npm-cache
  timeout: 10 minutes
  script:
    - cd frontend/admin-ui
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/admin-ui/dist/
    expire_in: 1 hour
  tags:
    - docker

# =============================================================================
# TEST STAGE
# =============================================================================

backend-test:
  stage: test
  image: eclipse-temurin:21-jdk
  extends: .gradle-cache
  timeout: 20 minutes
  # ПРИМЕЧАНИЕ: Для Testcontainers требуется Runner с privileged mode
  # Тесты с Testcontainers будут пропущены если DinD недоступен
  allow_failure: true
  services:
    - name: docker:dind
      alias: docker
  variables:
    # Docker-in-Docker для Testcontainers
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    # Отключаем Ryuk для CI (он не нужен в ephemeral environments)
    TESTCONTAINERS_RYUK_DISABLED: "true"
  script:
    - chmod +x backend/gradlew
    - cd backend
    - ./gradlew test --parallel jacocoTestReport
  artifacts:
    when: always
    reports:
      junit:
        - backend/**/build/test-results/test/*.xml
    paths:
      - backend/**/build/reports/tests/test/
      - backend/**/build/reports/jacoco/test/
  needs:
    - job: backend-build
      optional: true
  tags:
    - docker

frontend-test:
  stage: test
  image: node:20-alpine
  extends: .npm-cache
  timeout: 10 minutes
  variables:
    # Keycloak env vars для тестов (валидация конфигурации)
    VITE_KEYCLOAK_URL: "http://localhost:8180"
    VITE_KEYCLOAK_REALM: "api-gateway"
    VITE_KEYCLOAK_CLIENT_ID: "admin-ui"
  script:
    - cd frontend/admin-ui
    - npm ci
    - npm run test:run
  needs:
    - frontend-build
  tags:
    - docker

# =============================================================================
# E2E TESTS (Optional — требует запущенного стека)
# =============================================================================

# e2e-test:
#   stage: test
#   image: mcr.microsoft.com/playwright:v1.42.0-jammy
#   timeout: 15 minutes
#   when: manual
#   allow_failure: true
#   script:
#     - cd frontend/admin-ui
#     - npm ci
#     - npx playwright test
#   artifacts:
#     when: always
#     paths:
#       - frontend/admin-ui/playwright-report/
#       - frontend/admin-ui/test-results/
#   needs:
#     - frontend-build
#   tags:
#     - docker

# =============================================================================
# SYNC STAGE (from Story 13.1)
# =============================================================================

# Синхронизация в GitHub (manual trigger)
# Запускается только вручную после merge в main
sync-to-github:
  stage: sync
  image: alpine:latest
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true
  script:
    - apk add --no-cache git
    - git config --global user.email "ci@localhost"
    - git config --global user.name "GitLab CI"
    - git remote add github https://oauth2:${GITHUB_TOKEN}@github.com/MorozovY/ApiGateway.git || true
    - git fetch --unshallow || true
    - git push github HEAD:master --force
    - git push github --tags --force
  tags:
    - docker
