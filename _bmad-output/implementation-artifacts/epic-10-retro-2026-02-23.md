# Epic 10 Retrospective: Maintenance & Bug Fixes

**Дата:** 2026-02-23
**Фасилитатор:** Bob (Scrum Master)
**Участники:** Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), Yury (Project Lead)

---

## Сводка Epic

| Метрика | Значение |
|---------|----------|
| **Историй завершено** | 10/10 (100%) |
| **Плановых историй** | 6 (из Epic 9 retro) |
| **Emergent историй** | 4 (10.7, 10.8, 10.9, 10.10) |
| **Code Review issues** | ~35+ найдено, все исправлены |
| **HIGH issues** | 3 (все исправлены до merge) |
| **CRITICAL bug fixed** | Rate limiting (math.floor) |
| **Production incidents** | 0 |
| **Статус** | Done |

### Доставленные истории

| История | Название | Тип | Severity | CR Issues |
|---------|----------|-----|----------|-----------|
| 10.1 | Rate Limit Not Working | Bugfix | CRITICAL | 4 (M2, L2) |
| 10.2 | Approvals Real-Time Updates | Bugfix | MEDIUM | 7 (3 rounds) |
| 10.3 | Security Route Rollback | Feature | — | 6 (H3, M3) |
| 10.4 | Author Delete Draft | Feature | — | 4 (M3, L1) |
| 10.5 | Nginx Health Check | Feature | — | 3 (H1, M1, L1) |
| 10.6 | Swagger Links Login Page | UX | — | 2 (M2) |
| 10.7 | Quick Start Guide | Documentation | — | 3 |
| 10.8 | Fix Audit Changes Viewer | Bugfix | MEDIUM | 4 |
| 10.9 | Fix Theme Modals/Messages | Bugfix | LOW | 3 |
| 10.10 | Fix Top Routes Time Range | Bugfix | MEDIUM | 3 (M3) |

---

## Что пошло хорошо

### Доставка продукта

- **100% completion** — четвёртый эпик подряд с полным завершением
- **CRITICAL bug fixed** — Rate limiting работает корректно после исправления `math.floor` в Lua
- **Все 6 action items из Epic 9 закрыты:**
  - BUG-04 (Rate limit) → Story 10.1 ✅
  - BUG-03 (Approvals real-time) → Story 10.2 ✅
  - FR-01 (Security rollback) → Story 10.3 ✅
  - FR-04 (Author delete draft) → Story 10.4 ✅
  - FR-02 (Nginx health check) → Story 10.5 ✅
  - FR-03 (Swagger links) → Story 10.6 ✅
- **4 дополнительные stories** — Quick Start Guide, Audit Viewer fix, Theme support, Top Routes fix

### Техническое качество

- **Story 10.1 Root Cause Analysis** — корневая причина найдена быстро:
  - `math.floor(elapsed * rate)` терял дробные токены
  - При rate=5 и elapsed=0.1 сек: `floor(0.5) = 0`
  - Исправлено: дробные значения для refill, `math.floor` только в ответе API

- **Story 10.9 Architecture fix** — App wrapper для Ant Design static методов
  - `Modal.confirm()`, `message.success()` теперь уважают тему
  - 20 файлов обновлено, паттерн унифицирован

- **Story 10.10 Full-stack fix** — period параметр через все слои:
  - metricsApi → useMetrics → MetricsPage → MetricsController → MetricsService → PromQLBuilder

### Code Review эффективность

- **35+ issues найдено до merge**
- **3 HIGH severity issues пойманы:**
  - 10.3: Role check в UPPERCASE вместо lowercase — кнопка никогда бы не показалась
  - 10.3: Audit log без `rolledbackAt`/`rolledbackBy` полей
  - 10.5: docker-compose.override.yml.example не обновлён

---

## Проблемы и обучение

### 1. Role check case sensitivity

**Проблема:** В Stories 10.3 и 10.4 проверка ролей использовала UPPERCASE (`'SECURITY'`), а тип User.role хранит lowercase (`'security'`).

**Root cause:** Копирование кода без проверки типов, отсутствие централизованных хелперов.

**Решение:** Рефакторинг — создать `canRollback()`, `canDelete()`, `canModify()` с TypeScript literal types.

### 2. docker-compose.override.yml.example

**Проблема:** При добавлении новых env vars (NGINX_URL, GATEWAY_CORE_URL) забывали обновить example файл.

**Root cause:** Нет чеклиста для env var changes.

**Решение:** При добавлении env var → обновить example файл (добавить в code review checklist).

### 3. Недокументированные технологии

**Проблема:** Lua, Redis Pub/Sub, WebFlux patterns не описаны в документации проекта.

**Root cause:** Технологии добавлялись по мере необходимости без документирования.

**Решение:** Создать документацию для ключевых технологий в Epic 11.

---

## Выполнение Action Items из Epic 9

| # | Action Item | Story | Статус |
|---|-------------|-------|--------|
| BUG-04 | Rate limit не работает | 10.1 | ✅ Done |
| BUG-03 | Approvals real-time updates | 10.2 | ✅ Done |
| FR-01 | Security rollback route | 10.3 | ✅ Done |
| FR-04 | Author delete draft | 10.4 | ✅ Done |
| FR-02 | Nginx health check | 10.5 | ✅ Done |
| FR-03 | Swagger link on login | 10.6 | ✅ Done |

**Итого:** 6/6 выполнено (100%)

---

## Метрики качества тренд

| Метрика | Epic 7 | Epic 8 | Epic 9 | Epic 10 | Тренд |
|---------|--------|--------|--------|---------|-------|
| Плановых историй | 8 | 10 | 6 | 6 | — |
| Emergent/Hotfix | 3 | 0 | 0 | 4 | — |
| Completion rate | 100% | 100% | 100% | 100% | ✅ 4/4 |
| Action items done | 10/10 | 7/7 | 6/6 | — | ✅ Стабильно |
| Production incidents | 0 | 0 | 0 | 0 | ✅ Стабильно |
| Frontend tests | 517 | 526 | 544 | 548 | ✅ Рост |

---

## Action Items Epic 10

### Process Improvements

| # | Action Item | Owner | Priority | Статус |
|---|-------------|-------|----------|--------|
| PI-01 | Рефакторинг проверки ролей — централизованные хелперы с TypeScript literal types | Charlie | MEDIUM | Pending |

### Epic 11 Backlog

| # | Item | Type | Priority | Описание |
|---|------|------|----------|----------|
| FR-01 | Integrations expandable routes | Feature | MEDIUM | Показывать маршруты в expandable row вместо навигации |
| FR-02 | System theme default | Feature | LOW | `prefers-color-scheme` при первом запуске |
| DOC-01 | Lua + Redis rate limiting | Docs | MEDIUM | Token bucket алгоритм, Redis структура, отладка |
| DOC-02 | Redis Pub/Sub | Docs | MEDIUM | Route cache sync между gateway-admin и gateway-core |
| DOC-03 | WebFlux patterns | Docs | MEDIUM | Reactive паттерны, когда и как использовать |

---

## Ключевые выводы

1. **CRITICAL bug fixed** — Rate limiting теперь работает корректно
2. **100% Action Items** — третий эпик подряд с полным выполнением обязательств
3. **Code Review эффективен** — HIGH issues ловятся до merge
4. **Role check pattern** — требует рефакторинга для предотвращения ошибок
5. **Документация** — Lua, Redis Pub/Sub, WebFlux требуют описания

---

## Next Steps

1. **Создать Epic 11: UX Improvements & Documentation**
   - FR-01: Integrations expandable routes
   - FR-02: System theme default
   - DOC-01, DOC-02, DOC-03: Technology documentation
   - PI-01: Role check refactoring

2. **Обновить sprint-status.yaml**
   - Epic 10 retrospective → done
   - Epic 11 → backlog

---

*Сгенерировано в ходе Team Retrospective 2026-02-23*
*Следующий шаг: Epic 11 Creation*
