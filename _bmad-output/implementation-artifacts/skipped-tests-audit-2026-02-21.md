# Аудит Skipped Тестов

**Дата:** 2026-02-21
**Автор:** Elena (Junior Dev) + Bob (SM)
**Action Item:** E6-06
**Статус:** ✅ ИСПРАВЛЕНО

---

## Сводка

| Категория | Количество | Статус |
|-----------|------------|--------|
| Намеренно пропущенные | 1 | ✅ Документировано |
| Технический долг | 2 → 0 | ✅ **ИСПРАВЛЕНО** |
| **Итого** | **3** → **1** | |

---

## Исправления (2026-02-21)

**Проблема:** Два unit теста в `RouteFormPage.test.tsx` были помечены `it.skip()` из-за проблем с Ant Design Form в тестовом окружении.

**Root Cause:**
1. Ant Design async-validator не принимает hostname без TLD (например `http://keyboard:8080`)
2. Требовалось добавить мок для `@features/rate-limits`
3. Требовалось использовать `act()` для синхронизации React state

**Решение:**
1. Изменены URL в тестах на `http://localhost:8080` (валидный URL)
2. Добавлен мок для `useRateLimits`
3. Добавлены `act()` wrappers для render и событий
4. Убраны `it.skip()` — тесты теперь активны

**Результат:** Все 354 unit теста проходят (было 352 + 2 skipped).

---

## Найденные Skipped Тесты

### 1. E2E: Grafana Dashboard (Conditional Skip)

**Файл:** `frontend/admin-ui/e2e/epic-6.spec.ts:323`

**Код:**
```typescript
test('Grafana dashboard работает', async ({ page }) => {
  // Проверяем полную доступность Grafana (health + login)
  // ...
  test.skip(!grafanaAvailable, 'Grafana is not available...')
```

**Поведение:** Тест запускается, но пропускается если Grafana недоступна.

**Классификация:** ✅ **Conditional skip (улучшено)**

**Обоснование:**
- Grafana не запускается по умолчанию (опциональный профиль monitoring)
- Тест проверяет health + login перед выполнением
- Gracefully пропускается с понятным сообщением
- Документирован с инструкциями как запустить

**Улучшение (2026-02-21):** Убран `test.skip()` на уровне объявления, добавлен conditional skip внутри теста.

---

### 2. Unit: RouteFormPage Edit Redirect (Технический долг)

**Файл:** `frontend/admin-ui/src/features/routes/components/RouteFormPage.test.tsx:285`

**Код:**
```typescript
// TODO: Тест требует дополнительной настройки для корректной работы
// с Ant Design Form в режиме редактирования. Form.setFieldsValue в useEffect
// не полностью синхронизируется с состоянием формы в тестовом окружении.
// Функциональность проверена вручную и работает в браузере.
it.skip('редиректит после успешного обновления в режиме редактирования', async () => {
```

**Причина:** Ant Design Form.setFieldsValue в useEffect не синхронизируется с тестовым окружением

**Классификация:** ⚠️ **Технический долг**

**Обоснование:**
- Функциональность работает в браузере (проверено вручную)
- Проблема в интеграции Vitest + React Testing Library + Ant Design Form
- TODO комментарий документирует причину

**Рекомендация:**
- Исследовать использование `act()` и `waitFor()` для синхронизации Form state
- Или использовать `@testing-library/user-event` v14+ с advanceTimers
- Приоритет: LOW — функциональность покрыта E2E тестами

---

### 3. Unit: RouteFormPage Ctrl+Enter Submit (Технический долг)

**Файл:** `frontend/admin-ui/src/features/routes/components/RouteFormPage.test.tsx:397`

**Код:**
```typescript
// TODO: Тест успешного submit через keyboard shortcut требует
// дополнительной настройки для Ant Design Form. Keyboard shortcut
// вызывает form.submit(), но в тестовом окружении это не приводит
// к вызову onFinish. Функциональность проверена в браузере.
it.skip('успешно отправляет форму по Ctrl+Enter в режиме редактирования', async () => {
```

**Причина:** form.submit() в keyboard shortcut не вызывает onFinish в тестовом окружении

**Классификация:** ⚠️ **Технический долг**

**Обоснование:**
- Аналогичная проблема с Ant Design Form в тестах
- Keyboard shortcut (Ctrl+Enter) проверен в браузере
- Связанный тест валидации работает (строка 361)

**Рекомендация:**
- Объединить с исправлением теста #2 (та же root cause)
- Приоритет: LOW — keyboard shortcut не критичная функциональность

---

## План устранения (E6-07)

### Приоритеты

| # | Тест | Приоритет | Действие |
|---|------|-----------|----------|
| 1 | Grafana E2E | — | Оставить (намеренно) |
| 2 | Edit Redirect | LOW | Исследовать Ant Design + Vitest интеграцию |
| 3 | Ctrl+Enter | LOW | Исправить вместе с #2 |

### Рекомендуемый подход

**Вариант A: Исправить тесты (1-2 часа)**
1. Исследовать `form.submit()` vs `form.validateFields().then(onFinish)`
2. Добавить `await act(async () => {...})` wrapper
3. Использовать `vi.useFakeTimers()` для Ant Design анимаций

**Вариант B: Заменить на E2E (30 минут)**
1. Убедиться что E2E тесты покрывают эти сценарии
2. Удалить skipped unit тесты как redundant
3. Задокументировать в Dev Notes

**Рекомендация:** Вариант B — E2E тесты epic-5.spec.ts уже покрывают создание и редактирование маршрутов через UI.

---

## Метрики

| Метрика | Значение |
|---------|----------|
| Всего skipped тестов | 3 |
| Намеренно пропущенных | 1 (33%) |
| Технический долг | 2 (67%) |
| Критических | 0 |
| Требуют немедленного исправления | 0 |

---

## Заключение

Состояние skipped тестов в проекте **отличное**:
- ✅ Только 1 намеренно пропущенный тест (Grafana E2E — требует `--profile monitoring`)
- ✅ 2 технических долга **исправлены** в Tech Sprint
- ✅ Все 354 unit теста проходят
- ✅ Все E2E тесты проходят

**Итог:** Технический долг по skipped тестам полностью погашен.

---

*Аудит выполнен в рамках Tech Sprint (Action Item E6-06)*
*Исправления применены: 2026-02-21*
