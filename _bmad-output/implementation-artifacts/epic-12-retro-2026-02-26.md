# Epic 12 Retrospective: Keycloak Integration & Multi-tenant Metrics

**–î–∞—Ç–∞:** 2026-02-26
**Facilitator:** Bob (Scrum Master)
**–£—á–∞—Å—Ç–Ω–∏–∫–∏:** Alice (Product Owner), Charlie (Senior Dev)
**Epic:** 12 - Keycloak Integration & Multi-tenant Metrics
**Stories:** 11 (–≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã)

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ Epic

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –í—Å–µ–≥–æ stories | 11 |
| –ó–∞–≤–µ—Ä—à–µ–Ω–æ | 11 (100%) |
| Frontend —Ç–µ—Å—Ç—ã | 683+ |
| Backend —Ç–µ—Å—Ç—ã | 840+ |
| E2E —Ç–µ—Å—Ç—ã | 25 |
| Code review issues | 47 |
| –ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã | 1 (Story 12.2) |
| Process Agreements —Å–æ–∑–¥–∞–Ω—ã | 3 (PA-08, PA-09, PA-10) |

---

## ‚úÖ –ß—Ç–æ –ø–æ—à–ª–æ —Ö–æ—Ä–æ—à–æ

### 1. –ü–æ–ª–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- –í—Å–µ 11 stories –∑–∞–≤–µ—Ä—à–µ–Ω—ã –±–µ–∑ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–Ω–∏—è
- Keycloak –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç end-to-end
- Multi-tenant –º–µ—Ç—Ä–∏–∫–∏ —Å consumer_id labels –≤ Prometheus
- Consumer Management UI –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω

### 2. Feature Flag Pattern
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤ Stories 12.2, 12.4, 12.7
- –ü–æ–∑–≤–æ–ª–∏–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å auth –±–µ–∑ downtime
- `security.keycloak.enabled` ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É Keycloak –∏ legacy

### 3. Dual-mode SecurityConfig
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Keycloak JWT –∏ legacy cookie auth –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- Graceful migration path –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è legacy (Story 12.9.1)

### 4. –ö–∞—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- 683+ frontend —Ç–µ—Å—Ç–æ–≤ (Vitest)
- 840+ backend —Ç–µ—Å—Ç–æ–≤ (JUnit + Testcontainers)
- 25 E2E —Ç–µ—Å—Ç–æ–≤ (Playwright)
- Testcontainers –¥–ª—è Keycloak integration tests

### 5. –†–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç (Story 12.2)
- –ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ Process Agreements –ø–æ—Å–ª–µ data loss
- PA-08: Non-Breaking Changes
- PA-09: Migration Pre-flight Checklist
- PA-10: Dangerous Operations Confirmation
- –ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ

### 6. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
- –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫–µ—à (Caffeine + Redis) –¥–ª—è rate limits
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Keycloak UUID –≤ E2E —Ç–µ—Å—Ç–∞—Ö
- Audit logging –¥–ª—è security compliance (FR21-FR24)

---

## üîß –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å

### 1. Story 12.2 –ò–Ω—Ü–∏–¥–µ–Ω—Ç
**–ü—Ä–æ–±–ª–µ–º–∞:** Data loss –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ auth ‚Äî —É–¥–∞–ª—ë–Ω —Ä–∞–±–æ—Ç–∞—é—â–∏–π –∫–æ–¥ –¥–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ
**–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ pre-flight checklist –∏ rollback –ø–ª–∞–Ω–∞
**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω—ã PA-08, PA-09, PA-10
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ—Ü–µ—Å—Å–Ω–æ

### 2. Caffeine Cache NPE (Story 12.8)
**–ü—Ä–æ–±–ª–µ–º–∞:** Caffeine –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç null values, –≤—ã–∑—ã–≤–∞–ª–æ NullPointerException
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∑–Ω–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Cache<String, Optional<ConsumerRateLimit>>`
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–¥–µ

### 3. Mono.defer Pattern (Story 12.8)
**–ü—Ä–æ–±–ª–µ–º–∞:** switchIfEmpty –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –ø—Ä–∏ —Å–±–æ—Ä–∫–µ chain, –∞ –Ω–µ runtime
**–ü—Ä–∏—á–∏–Ω–∞:** –¢–∏–ø–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ reactive programming
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Mono.defer { ... }` –¥–ª—è lazy evaluation
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–¥–µ

### 4. Keycloak UUID Synchronization (Story 12.10)
**–ü—Ä–æ–±–ª–µ–º–∞:** FK constraint violations –∏–∑-–∑–∞ hardcoded Keycloak UUID
**–ü—Ä–∏—á–∏–Ω–∞:** Keycloak –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ UUID –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
**–†–µ—à–µ–Ω–∏–µ:** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ UUID —á–µ—Ä–µ–∑ Admin API –≤ global-setup.ts
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–¥–µ

### 5. E2E —Ç–µ—Å—Ç—ã –≤ –∫–æ–Ω—Ü–µ Epic
**–ü—Ä–æ–±–ª–µ–º–∞:** E2E —Ç–µ—Å—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –≤ Story 12.10 (–ø–æ—Å–ª–µ–¥–Ω—è—è)
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ epic –±–µ–∑ —Ä–∞–Ω–Ω–µ–≥–æ E2E coverage
**–†–µ—à–µ–Ω–∏–µ:** –í —Å–ª–µ–¥—É—é—â–∏—Ö epics –¥–æ–±–∞–≤–ª—è—Ç—å E2E —Ä–∞–Ω—å—à–µ
**–°—Ç–∞—Ç—É—Å:** üìã Action Item AI-03

### 6. Code Review Issues (47 total)
**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ stories:**
- 12.1: 1 issue
- 12.2: 4 issues + INCIDENT
- 12.3: 6 issues
- 12.4: 5 issues
- 12.5: 4 issues
- 12.6: 5 issues
- 12.7: 5 issues
- 12.8: 6 issues
- 12.9: 5 issues
- 12.9.1: 3 issues
- 12.10: 3 issues

**–ü–∞—Ç—Ç–µ—Ä–Ω—ã issues:**
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –≤–º–µ—Å—Ç–æ —Ä—É—Å—Å–∫–æ–≥–æ (LOW)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ correlation ID –≤ –ª–æ–≥–∞—Ö (MEDIUM)
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (MEDIUM)
- –ù–µ–ø–æ–ª–Ω—ã–µ test assertions (LOW)

---

## üìã Action Items

| ID | Priority | Category | Description | Owner | Due |
|----|----------|----------|-------------|-------|-----|
| **AI-01** | HIGH | Process | –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å PA-09 (Migration Pre-flight Checklist) –≤ story template –¥–ª—è –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö stories | SM | Sprint 13 |
| **AI-02** | MEDIUM | Technical | –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç "Reactive Patterns Cookbook" ‚Äî Mono.defer, switchIfEmpty, cache nullability, error handling | Tech Lead | Sprint 14 |
| **AI-03** | MEDIUM | Process | E2E —Ç–µ—Å—Ç—ã –¥–æ–±–∞–≤–ª—è—Ç—å —Ä–∞–Ω—å—à–µ –≤ epic ‚Äî –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é story, —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ features | PO + Dev | Ongoing |
| **AI-04** | LOW | Technical | –ù–∞—Å—Ç—Ä–æ–∏—Ç—å lint rules –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (ESLint plugin) | Dev | Sprint 15 |
| **AI-05** | LOW | Documentation | –°–æ–∑–¥–∞—Ç—å post-mortem template –Ω–∞ –æ—Å–Ω–æ–≤–µ Story 12.2 –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ | SM | Sprint 14 |

---

## üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å Epic 11

| –ú–µ—Ç—Ä–∏–∫–∞ | Epic 11 | Epic 12 | –¢—Ä–µ–Ω–¥ |
|---------|---------|---------|-------|
| Stories | 8 | 11 | ‚Üë +37% |
| –ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã | 0 | 1 | ‚Üì |
| Process Agreements | 0 | 3 | ‚Üë (—Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç) |
| E2E —Ç–µ—Å—Ç—ã | 35 | 25 | ‚Üí (—Ä–∞–∑–Ω—ã–π scope) |

**–í—ã–≤–æ–¥—ã:**
- Epic 12 –±—ã–ª –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–º (auth migration)
- –ò–Ω—Ü–∏–¥–µ–Ω—Ç –ø—Ä–∏–≤—ë–ª –∫ —Å–æ–∑–¥–∞–Ω–∏—é –≤–∞–∂–Ω—ã—Ö PA
- –ö–æ–º–∞–Ω–¥–∞ –ø–æ–∫–∞–∑–∞–ª–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —É—á–∏—Ç—å—Å—è –Ω–∞ –æ—à–∏–±–∫–∞—Ö

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

1. **Feature flags ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π** ‚Äî –¥–æ–∫–∞–∑–∞–ª–∏ —Å–≤–æ—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –≤ Stories 12.2, 12.4, 12.7
2. **Pre-flight checklist –∫—Ä–∏—Ç–∏—á–µ–Ω** ‚Äî Story 12.2 –∏–Ω—Ü–∏–¥–µ–Ω—Ç –º–æ–≥ –±—ã—Ç—å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â—ë–Ω
3. **Reactive programming —Ç—Ä–µ–±—É–µ—Ç —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã** ‚Äî Mono.defer, Caffeine nullability ‚Äî –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ gotchas
4. **E2E —Ç–µ—Å—Ç—ã —Ä–∞–Ω—å—à–µ = –º–µ–Ω—å—à–µ —Å—é—Ä–ø—Ä–∏–∑–æ–≤** ‚Äî Story 12.10 –≤—ã—è–≤–∏–ª–∞ UUID sync –ø—Ä–æ–±–ª–µ–º—É
5. **Process Agreements —Ä–∞–±–æ—Ç–∞—é—Ç** ‚Äî PA-08, PA-09, PA-10 —É–∂–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è

---

*–°–ª–µ–¥—É—é—â–∞—è —Ä–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤–∞: Epic 13*
