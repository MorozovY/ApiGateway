# Epic 7 Retrospective: Audit & Compliance

**Дата:** 2026-02-21
**Фасилитатор:** Bob (Scrum Master)
**Участники:** Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), Yury (Project Lead)

---

## Сводка Epic

| Метрика | Значение |
|---------|----------|
| **Историй завершено** | 11/11 (100%) |
| **Плановых историй** | 8 (7.0–7.7) |
| **Emergent/Hotfix историй** | 3 (7.7.1, 7.7.2, 7.7.3) |
| **Баги подтверждённые** | 1 (7.7.3: multi-select action) |
| **Баги не воспроизводимые** | 2 (7.7.1, 7.7.2) |
| **Code Review rounds** | 14+ |
| **E2E тестов добавлено** | 5 (всего: ~28) |
| **Unit тестов frontend** | 352 passed |
| **Production incidents** | 0 |
| **FR закрыто** | FR21, FR22, FR23, FR24 |
| **Статус** | Done |

### Доставленные истории

| История | Название | Статус | Тип |
|---------|----------|--------|-----|
| 7.0 | MetricsService → Prometheus HTTP API | Done | Backend (Critical) |
| 7.1 | Audit Log Entity & Event Recording | Done | Backend |
| 7.2 | Audit Log API with Filtering | Done | Backend |
| 7.3 | Route Change History API | Done | Backend |
| 7.4 | Routes by Upstream Filter | Done | Backend |
| 7.5 | Audit Log UI | Done | Frontend |
| 7.6 | Route History & Upstream Report UI | Done | Frontend |
| 7.7 | E2E Playwright Happy Path Tests | Done | Testing |
| 7.7.1 | Fix Routes Actions | Done | Hotfix (Not Reproducible) |
| 7.7.2 | Fix Integration Tab | Done | Hotfix (Not Reproducible) |
| 7.7.3 | Fix Audit Logs Search | Done | Hotfix (Real Bug Fixed) |

---

## Что пошло хорошо

### Доставка продукта

- **100% completion** — третий эпик подряд, команда работает стабильно
- **Story 7.0** решила критический блокер с метриками — UI теперь показывает реальные данные из Prometheus
- **Audit & Compliance** полностью готов: аудит-логи, фильтрация, история маршрутов, upstream report, CSV экспорт
- **Role-based access** реализован для всех новых страниц

### Техническое качество

- **Prometheus HTTP API Integration** — PrometheusClient с retry и fallback на mock data
- **Graceful Degradation** — audit logging не блокирует основные операции (fire-and-forget pattern)
- **Reactor Context** — IP и Correlation ID передаются через reactive chain
- **R2DBC Criteria API** — type-safe динамические запросы для фильтрации
- **Multi-select action filter** — поддержка ANY() в PostgreSQL (исправлено в 7.7.3)

### Frontend качество

- Переиспользование ChangesViewer между AuditPage и RouteHistoryTimeline
- Collapsible Sidebar с localStorage persistence
- URL sync для всех фильтров через useSearchParams
- Parallel fetch для CSV экспорта (MAX_CONCURRENT_REQUESTS = 5)

### Тестирование

- **E2E тесты прошли все с первого полного прогона** после code review
- 5 новых E2E тестов для Audit & Compliance
- 352 unit теста frontend все проходят
- Только 1 реальный баг найден при E2E (7.7.3 — multi-select action)

### Code Review эффективность

- Story 7.1: 2 HIGH issues (graceful degradation) — исправлены
- Story 7.5: 2 rounds, 11 issues исправлены
- Story 7.6: 2 HIGH, 5 MEDIUM исправлены
- Story 7.7: 2 CRITICAL исправлены (debug file, AC3 UI test)

---

## Проблемы и обучение

### 1. Hotfix сторис — 2 из 3 не воспроизводились

**Проблема:** Stories 7.7.1 и 7.7.2 создались для багов, но исследование показало что баги не воспроизводятся.

**Root cause:**
- Возможно кэш браузера после E2E тестов
- Race condition при быстрой навигации
- Временные сетевые проблемы

**Решение:** Hotfix stories должны требовать reproduction steps перед созданием.

### 2. Story 7.7.3 — Реальный баг multi-select action

**Проблема:** Frontend поддерживал multi-select для action filter, но backend использовал простое сравнение `WHERE action = :action`.

**Root cause:** Несогласованность между frontend и backend API contract.

**Решение:** Исправлен backend для поддержки `ANY()` с массивом. API Dependencies checklist нужен формально.

### 3. Action Items из Epic 6 — низкий completion rate

**Статистика:** 1 из 8 items выполнен за Epic 7 (только E6-08 — критический Story 7.0).

**Root cause:** Нет процесса review action items в Sprint Planning.

**Решение:** Tech Sprint для закрытия всех долгов + процесс review на Sprint Planning.

---

## Выполнение Action Items из Epic 6 Retro

| # | Action Item | Статус | Комментарий |
|---|-------------|--------|-------------|
| E6-01 | API Dependencies checklist | ❌ Не формализован | Story 7.7.3 показала необходимость |
| E6-02 | Документировать gateway метрики | ❌ Не сделан | Перенесён в Tech Sprint |
| E6-03 | Filter ordering documentation | ❌ Не сделан | Перенесён в Tech Sprint |
| E6-04 | correlationId logging через MDC | ❌ Backlog | Перенесён в Tech Sprint |
| E6-05 | Документировать Redis pub/sub | ❌ Не сделан | Перенесён в Tech Sprint |
| E6-06 | Аудит skipped тестов | ❌ Не сделан | Перенесён в Tech Sprint |
| E6-07 | Story для skipped тестов | ❌ Не создана | Зависит от E6-06 |
| E6-08 | Story 7.0 MetricsService | ✅ Done | CRITICAL blocker resolved |

**Итого:** 1 выполнен, 7 перенесены в Tech Sprint

---

## Action Items Epic 7

### Процессные улучшения

| # | Действие | Владелец | Приоритет | Deadline |
|---|----------|----------|-----------|----------|
| E7-01 | Формализовать API Dependencies checklist в story template | SM (Bob) | HIGH | Tech Sprint |
| E7-02 | Review Action Items в Sprint Planning — SM проверяет retro-actions.yaml | SM (Bob) | HIGH | Постоянно |
| E7-03 | Hotfix stories требуют reproduction steps | QA (Dana) | HIGH | Tech Sprint |

### Процессные соглашения

| # | Соглашение | Описание |
|---|------------|----------|
| PA-03 | Hotfix reproduction required | Баг должен быть воспроизведён перед созданием hotfix story |
| PA-04 | Action Items review | SM проверяет retro-actions.yaml на каждом Sprint Planning |

---

## Метрики качества тренд

| Метрика | Epic 5 | Epic 6 | Epic 7 | Тренд |
|---------|--------|--------|--------|-------|
| Плановых историй | 5 | 7 | 8 | ↑ Рост |
| Emergent/Hotfix | 5 | 1 | 3 | → Стабильно |
| Реальных багов | ? | 1 | 1 | → Стабильно |
| Not Repro багов | ? | 0 | 2 | ↑ Новый паттерн |
| E2E тестов | 4 | 8 | 5 | ↑ Накопление |
| Action Items done | 2/6 | 1/8 | Tech Sprint | ↓ Требует процесс |
| Production incidents | 0 | 0 | 0 | ✓ Стабильно |

---

## Решение: Tech Sprint

**Причина:** Накоплено 10+ открытых action items из Epic 5, 6, 7.

**План:**
- День 1: Документация + Процесс (~5h)
- День 2: Аудит + Код (~6h)

**Items для закрытия:**
- E6-02, E6-03, E6-05: Документация в architecture.md
- E6-04: correlationId MDC logging
- E6-06, E6-07: Аудит и план для skipped тестов
- E7-01, E7-02, E7-03: Процессные улучшения
- PA-03, PA-04: Process Agreements

---

## Ключевые выводы

1. **100% completion третий эпик подряд** — команда стабильна
2. **Critical blocker E6-08 закрыт** — MetricsService работает с Prometheus
3. **Action items накапливаются** — нужен процесс review в Sprint Planning
4. **Hotfix stories без reproduction** — 2 из 3 не воспроизводились
5. **Code Review эффективен** — все HIGH/CRITICAL issues пойманы
6. **Tech Sprint запланирован** — закрытие всех накопившихся долгов

---

## Next Steps

1. Tech Sprint: закрытие всех action items
2. Обновление architecture.md с документацией
3. Формализация API Dependencies checklist
4. Аудит skipped тестов

---

*Сгенерировано в ходе Team Retrospective*
*Следующий шаг: Tech Sprint*
