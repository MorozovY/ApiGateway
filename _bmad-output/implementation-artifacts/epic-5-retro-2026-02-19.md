# Epic 5 Retrospective: Rate Limiting

**Дата:** 2026-02-19
**Фасилитатор:** Bob (Scrum Master)
**Участники:** Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), Yury (Project Lead)

---

## Сводка Epic

| Метрика | Значение |
|---------|----------|
| **Историй завершено** | 10/10 (100%) |
| **Плановых историй** | 5 (5.1–5.5) |
| **Добавленных историй** | 5 (5.6–5.10) — E2E и исправления |
| **Backend тесты** | Unit + Integration для RateLimitFilter, TokenBucket |
| **Frontend тесты** | React Query hooks, RateLimitsTable, RateLimitFormModal |
| **E2E тесты** | 4 теста в epic-5.spec.ts (все проходят) |
| **FR закрыто** | FR13 (Rate Limiting) |
| **Статус** | Done |

### Доставленные истории

| История | Название | Статус | Тип |
|---------|----------|--------|-----|
| 5.1 | Rate Limit Policy CRUD API | Done | Feature |
| 5.2 | Assign Rate Limit to Route API | Done | Feature |
| 5.3 | Rate Limiting Filter Implementation | Done | Feature |
| 5.4 | Rate Limit Policies Management UI | Done | Feature |
| 5.5 | Assign Rate Limit to Route UI | Done | Feature |
| 5.6 | E2E Playwright Happy Path Tests | Done | Testing |
| 5.7 | E2E Infrastructure Improvements | Done | Infra |
| 5.8 | Fix E2E Gateway Cache Sync | Done | Bug Fix |
| 5.9 | Fix E2E Rate Limits Table Refetch | Done | Bug Fix |
| 5.10 | Fix Gateway Routing Path Handling | Done | Bug Fix |

---

## Что пошло хорошо

### Доставка продукта

- **Rate Limiting полностью реализован** — Token Bucket через Redis Lua script, X-RateLimit-* headers, HTTP 429 RFC 7807
- **Graceful Degradation** — Caffeine fallback при недоступности Redis (50% от лимитов) — NFR4 ✅
- **Admin UI** — создание, редактирование, удаление политик через RateLimitsPage
- **Developer self-service** — назначение rate limit через dropdown в RouteForm
- **E2E happy path coverage** — все 4 AC сценария проходят

### Техническое качество

- **Token Bucket implementation** — атомарный Lua script в Redis, правильный burst handling
- **GlobalFilter order** — RateLimitFilter (order: 10) + RewritePath filter (order: 10001) корректно работают в pipeline
- **Redis Pub/Sub** — cache invalidation при создании/обновлении rate limit политик (Story 5.8)
- **React Query patterns** — staleTime: 0 + refetchOnMount: 'always' для свежести данных (Story 5.9)
- **DynamicRouteLocator fallback** — загрузка маршрутов из БД при пустом кэше (Story 5.8)

### E2E инфраструктура (Story 5.7)

- **Database cleanup** — global-setup.ts удаляет e2e-* данные перед тестами
- **Search filters** — добавлены на RateLimitsTable и ApprovalsPage для изоляции тестов
- **Development Commands** — документированы в CLAUDE.md для быстрого старта

### Code Review как safety net

- Все HIGH severity issues пойманы до merge
- CreateRouteRequest missing rateLimitId — критичный баг в API
- Redis pub/sub для rate limit events — без этого gateway-core не видит новые политики

---

## Проблемы и обучение

### Scope увеличился вдвое

**Факт:** Планировали 5 историй (5.1–5.5), доставили 10 (5.1–5.10).

**Причина:** E2E тестирование (Story 5.6) обнаружило 4 инфраструктурных проблемы, каждая стала отдельной историей.

| Story | Обнаруженная проблема |
|-------|----------------------|
| 5.7 | БД замусорена тестовыми данными, тесты конфликтуют |
| 5.8 | Gateway-core не получает cache invalidation (Redis pub/sub отсутствует) |
| 5.9 | React Query кэш stale после API mutations |
| 5.10 | Upstream path теряется при проксировании |

**Вывод:** E2E тестирование — это "acceptance gate". Без него проблемы обнаружились бы в production.

### Технические проблемы

| История | Проблема | Разрешение |
|---------|----------|------------|
| 5.2 | CreateRouteRequest missing rateLimitId field | Добавлено поле в DTO |
| 5.3 | RateLimitFilter не видит политики в gateway-core | Story 5.8: Redis pub/sub |
| 5.4 | RateLimitsTable — поиск отсутствует | Story 5.7: добавлен Input.Search |
| 5.5 | RouteForm — Rate Limit Select без data-testid | Code review fix |
| 5.6 | AC3 & AC4 skipped — инфраструктурные проблемы | Stories 5.8, 5.9, 5.10 |
| 5.8 | DynamicRouteLocator возвращает пустой Flux | Fallback loadFromDatabase() |
| 5.9 | Table показывает stale данные после API mutation | staleTime: 0 + refetchOnMount |
| 5.10 | Upstream URL path (/v1/api) теряется | OrderedGatewayFilter (order=10001) |

### Паттерн: Integration boundaries

**Наблюдение:** Большинство багов возникло на границах интеграции:
1. **Frontend → Backend API** — CreateRouteRequest missing field
2. **Backend → Redis** — pub/sub channels для cache invalidation
3. **Gateway → Upstream** — path rewriting при проксировании
4. **React Query → API** — stale cache при external mutations

**Вывод:** Unit тесты покрывают компоненты, но не границы. E2E тесты критически важны.

### E2E test flakiness

**Проблема:** Тесты AC3 и AC4 изначально были skipped из-за:
1. Отсутствия Redis pub/sub (gateway-core не синхронизировался)
2. React Query stale cache (navigation не триггерит refetch)
3. Table selectors нестабильны без data-testid

**Исправления:**
- data-testid для всех interactive элементов (Story 5.6 code review)
- Redis pub/sub для rate limit events (Story 5.8)
- staleTime: 0 + refetchOnMount: 'always' (Story 5.9)
- getByRole вместо текстовых селекторов

---

## Выполнение Action Items из Epic 4 Retro

| # | Action Item | Статус | Комментарий |
|---|-------------|--------|-------------|
| 1 | Исправить requiredRole в App.tsx | ✅ Выполнен | Исправлено в prep sprint перед Epic 5 |
| 2 | DoD: мульти-ролевые фичи тестировать все роли | ⏳ Частично | Применено в E2E (admin, developer, security) |
| 3 | Перенести open items в backlog | ❌ Не сделан | correlationId logging всё ещё открыт |
| 4 | correlationId logging через MDC | ❌ Не сделан | Backlog — Epic 6/7 scope |

**Итого:** 1 выполнен, 1 частично, 2 не сделаны.

---

## Паттерны Epic 5

### Паттерн: "Emergent stories"

**Описание:** При E2E тестировании обнаруживаются интеграционные проблемы, каждая становится отдельной историей.

**Рекомендация:** При планировании Epic 6+ закладывать 30-50% buffer на emergent stories после E2E.

### Паттерн: Cache invalidation across services

**Описание:** Gateway-core не получал updates о rate limit политиках, пока не добавили Redis pub/sub.

**Решение (Story 5.8):**
```kotlin
// Gateway-admin: публикует при создании/обновлении
redisTemplate.convertAndSend("rateLimit:cache:invalidate", rateLimitId)

// Gateway-core: подписывается и инвалидирует кэш
@EventListener
fun handleRateLimitInvalidation(message: RateLimitCacheInvalidationEvent)
```

**Рекомендация:** Любой distributed cache требует explicit invalidation strategy.

### Паттерн: OrderedGatewayFilter

**Описание:** Spring Cloud Gateway filters выполняются в порядке order. RouteToRequestUrlFilter (order=10000) устанавливает upstream URL, но теряет path.

**Решение (Story 5.10):**
```kotlin
OrderedGatewayFilter({ exchange, chain ->
    // Модифицируем GATEWAY_REQUEST_URL_ATTR
    val newUri = buildUri(upstreamPath + relativePath)
    exchange.attributes[GATEWAY_REQUEST_URL_ATTR] = newUri
    chain.filter(exchange)
}, 10001)  // После RouteToRequestUrlFilter
```

**Рекомендация:** Документировать filter ordering в архитектуре gateway.

---

## Preview Epic 6

**Epic 6: Monitoring & Observability** — 6 историй (6.1–6.6)

Зависимости от Epic 5:
- Rate limit metrics могут использовать X-RateLimit-* headers
- Per-route metrics включают rate limit rejections (429 count)
- Grafana dashboard может показывать rate limit utilization

Новые требования:
- Micrometer metrics collection
- Per-route request counts, latency percentiles
- Prometheus + Grafana setup
- Admin UI metrics summary view

**E2E история:** 6.6 — E2E Playwright happy path для Monitoring.

---

## Action Items

### Процессные улучшения

| # | Действие | Владелец | Приоритет |
|---|----------|----------|-----------|
| 1 | Закладывать 30-50% buffer в Epic planning на emergent stories | SM | HIGH |
| 2 | Добавить "Cache Invalidation" checklist item в Code Review | SM | MEDIUM |
| 3 | Обновить filter ordering documentation в architecture.md | Dev | LOW |

### Технический долг

| # | Действие | Владелец | Приоритет |
|---|----------|----------|-----------|
| 4 | correlationId logging в services через MDC | Dev | LOW — backlog |
| 5 | Документировать Redis pub/sub channels в architecture.md | Dev | MEDIUM |
| 6 | Story 5.6 file status: "in-progress" → "done" | SM | LOW |

---

## Ключевые выводы

1. **E2E тесты — acceptance gate** — 4 инфраструктурных бага обнаружены только через E2E, unit тесты их не видят
2. **Integration boundaries** — большинство проблем на стыках: Frontend↔Backend, Backend↔Redis, Gateway↔Upstream
3. **Distributed cache требует explicit invalidation** — Redis pub/sub обязателен для multi-service архитектуры
4. **Spring Cloud Gateway filter ordering критичен** — OrderedGatewayFilter с правильным order решает проблемы path rewriting
5. **React Query defaults не подходят для external mutations** — staleTime: 0 + refetchOnMount: 'always' для таблиц с API data
6. **Scope может расти вдвое** — 5 плановых историй → 10 доставленных (50% emergent)

---

## Метрики качества

| Метрика | Epic 4 | Epic 5 | Тренд |
|---------|--------|--------|-------|
| Плановых историй | 6 | 5 | — |
| Доставленных историй | 6 | 10 | ↑ +5 emergent |
| E2E тестов | 0 → 4 (prep) | 4 | ✓ Стабильно |
| Code review fixes | HIGH: 2 | HIGH: 3 | ↑ |
| Production bugs | 1 (admin/approvals) | 0 | ↓ Улучшение |

---

## Итог

Epic 5 доставлен с 100% completion rate. Rate Limiting с Token Bucket и graceful degradation работает. **Ключевое открытие:** E2E тестирование обнаружило 4 интеграционных проблемы, каждая стала отдельной историей. Без E2E эти баги попали бы в production. Соглашение "последняя история = E2E" (из Epic 4 retro) доказало свою ценность.

---

*Сгенерировано в ходе Team Retrospective*
*Следующий шаг: Epic 6 — Monitoring & Observability*
