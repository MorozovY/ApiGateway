# Epic 6 Retrospective: Monitoring & Observability

**Дата:** 2026-02-20
**Фасилитатор:** Bob (Scrum Master)
**Участники:** Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), Yury (Project Lead)

---

## Сводка Epic

| Метрика | Значение |
|---------|----------|
| **Историй завершено** | 8/8 (100%) |
| **Плановых историй** | 7 (6.0–6.6) |
| **Emergent историй** | 1 (6.5.1 — Role-Based Filtering hotfix) |
| **Code Review fixes** | 12 (3 HIGH, 6 MEDIUM, 3 LOW) |
| **E2E тестов добавлено** | 4 (всего в проекте: 23) |
| **Production incidents** | 0 |
| **FR закрыто** | FR17, FR18, FR19, FR20 |
| **Статус** | Done |

### Доставленные истории

| История | Название | Статус | Тип |
|---------|----------|--------|-----|
| 6.0 | Theme Switcher UI | Done | Feature (mini) |
| 6.1 | Metrics Collection with Micrometer | Done | Backend |
| 6.2 | Per-Route Metrics | Done | Backend |
| 6.3 | Metrics Summary API | Done | Backend |
| 6.4 | Prometheus & Grafana Setup | Done | Infrastructure |
| 6.5 | Basic Metrics View in Admin UI | Done | Frontend |
| 6.5.1 | Metrics API Role-Based Filtering | Done | Backend (hotfix) |
| 6.6 | E2E Playwright Happy Path Tests | Done | Testing |

---

## Что пошло хорошо

### Доставка продукта

- **100% completion** второй эпик подряд — команда стабилизировалась
- **1 emergent story** (6.5.1) vs 5 emergent в Epic 5 — planning улучшился
- **Theme Switcher** (6.0) — высокий user impact при минимальных затратах (dark mode)
- **FR17-FR20 закрыты** — DevOps имеет полную visibility в Gateway

### Техническое качество

- **Модульная архитектура метрик** — MetricsFilter → PathNormalizer → MetricsService легко расширять
- **Filter ordering** — HIGHEST_PRECEDENCE+10 для MetricsFilter измеряет полное время запроса
- **Role-based filtering** — Story 6.5.1 элегантно решила проблему через backend автофильтрацию
- **Sparkline charts** — @ant-design/charts интеграция с историей 30 минут (180 точек)
- **FOUC prevention** — inline script в index.html для раннего определения темы

### Infrastructure

- **Prometheus + Grafana setup** прошёл гладко — Docker Compose profiles (`--profile monitoring`)
- **Auto-provisioning** — datasource и dashboard готовы сразу после `docker-compose up`
- **7 панелей в Grafana dashboard** — RPS, latency percentiles, error rate, top routes, active connections, status distribution, errors by type

### E2E тестирование

- **E2E тесты прошли с первого полного прогона** после code review (vs 4 отдельных bugfix stories в Epic 5)
- **Все 23 E2E теста проходят** (1 skipped by design — Grafana требует --profile monitoring)

---

## Проблемы и обучение

### Story 6.5 AC6 — недостающая backend фильтрация

**Проблема:** Story 6.5 (UI) требовала role-based фильтрацию для developer, но backend API (Story 6.3) не поддерживал это. Обнаружено только на code review.

**Root cause:** При создании UI story не проверялось что backend endpoints поддерживают все AC.

**Решение:** Создана hotfix Story 6.5.1. Добавлен **API Dependencies checklist** в процесс создания UI stories.

### MetricsService архитектурная проблема

**Проблема:** UI метрики пустые, хотя в Grafana данные есть.

**Root cause:** MetricsService в gateway-admin читает из локального MeterRegistry, а метрики собираются в gateway-core. Два сервиса — две отдельные registry.

**Решение:** Story 7.0 — переработать MetricsService для query Prometheus HTTP API вместо локального MeterRegistry.

### Code Review находки

| Story | Severity | Issue | Исправлено |
|-------|----------|-------|------------|
| 6.1 | HIGH | Timer с publishPercentiles создавался на каждый запрос | ✅ |
| 6.3 | HIGH | p95/p99 percentiles всегда 0 | ✅ |
| 6.6 | HIGH | AC3 auto-refresh не проверялся | ✅ |
| 6.6 | HIGH | Трафик на /actuator/health не создаёт gateway метрики | ✅ |
| 6.4 | MEDIUM | Hard-coded datasource UID в Grafana alerts | ✅ |
| 6.5 | CRITICAL | AC6 фильтрация отсутствовала | ✅ (Story 6.5.1) |

**Вывод:** Code Review система работает — все HIGH issues пойманы до merge.

### Skipped тесты

**Проблема:** В проекте есть тесты в статусе skipped которые нужно разобрать.

**Решение:** Аудит всех `.skip()`, `@Disabled`, `@Ignore` + создание story на устранение.

### Action Items из Epic 5 — не выполнены

**Проблема:** 2 из 6 action items из Epic 5 retro не выполнены, 2 частично.

**Root cause:** Action items нигде не трекаются между ретроспективами.

**Решение:** Создать `retro-actions.yaml` для трекинга action items.

---

## Выполнение Action Items из Epic 5 Retro

| # | Action Item | Статус | Комментарий |
|---|-------------|--------|-------------|
| 1 | Закладывать 30-50% buffer на emergent stories | ✅ Применён | 1 emergent vs планировали 7 |
| 2 | Добавить "Cache Invalidation" checklist в Code Review | ⏳ Частично | Применялось, не формализовано |
| 3 | Обновить filter ordering docs в architecture.md | ❌ Не сделан | Перенесён в Epic 7 |
| 4 | correlationId logging через MDC | ❌ Backlog | Перенесён в Epic 7 |
| 5 | Документировать Redis pub/sub channels | ⏳ Частично | В Dev Notes, не в architecture.md |
| 6 | Story 5.6 file status → done | ✅ Сделан | sprint-status.yaml обновлён |

**Итого:** 2 выполнены, 2 частично, 2 не сделаны

---

## Action Items Epic 6

### Процессные улучшения

| # | Действие | Владелец | Приоритет | Deadline |
|---|----------|----------|-----------|----------|
| 1 | Создать `retro-actions.yaml` для трекинга action items | SM (Bob) | HIGH | До Epic 7 start |
| 2 | Добавить **API Dependencies checklist** в UI story template | SM (Bob) | HIGH | До Epic 7 start |
| 3 | Документировать что создаёт gateway метрики (только published routes) | Dev (Charlie) | MEDIUM | Sprint 1 Epic 7 |

### Технический долг

| # | Действие | Владелец | Приоритет |
|---|----------|----------|-----------|
| 4 | Filter ordering documentation в architecture.md | Dev (Charlie) | MEDIUM |
| 5 | correlationId logging через MDC | Dev | LOW — backlog |
| 6 | Документировать Redis pub/sub channels в architecture.md | Dev (Charlie) | LOW |

### Critical Path для Epic 7

| # | Действие | Владелец | Приоритет | Deadline |
|---|----------|----------|-----------|----------|
| 8 | Аудит skipped тестов — собрать все .skip(), @Disabled, @Ignore | Elena | HIGH | До Epic 7 start |
| 9 | Создать Story для устранения skipped тестов | SM (Bob) | HIGH | Backlog Epic 7 |
| 10 | **Story 7.0: MetricsService → Prometheus HTTP API** | Charlie | CRITICAL | Sprint 1 Epic 7 |

### Процессные соглашения

| # | Соглашение | Описание |
|---|------------|----------|
| 11 | **LOW issues исправляем сразу** | Code review не approved пока все severity levels не resolved |
| 12 | **API Dependencies checklist** | При создании UI story проверять что backend поддерживает все AC |

---

## Ключевые выводы

1. **100% completion второй эпик подряд** — команда стабилизировалась, процессы работают
2. **1 emergent story vs 5 в Epic 5** — planning и декомпозиция улучшились
3. **Code Review ловит HIGH issues** — система безопасности работает
4. **Action items терялись между ретро** — решено через retro-actions.yaml
5. **MetricsService архитектурно неверен** — требует Prometheus HTTP API (Story 7.0)
6. **LOW issues копились** — новое соглашение: исправляем сразу
7. **Skipped тесты — скрытый долг** — требует аудит и cleanup

---

## Метрики качества

| Метрика | Epic 5 | Epic 6 | Тренд |
|---------|--------|--------|-------|
| Плановых историй | 5 | 7 | ↑ |
| Emergent историй | 5 | 1 | ↓ Улучшение |
| Code review HIGH fixes | 3 | 3 | → Стабильно |
| E2E тестов | 4 | 4 (+4 = 8 total) | ↑ |
| Production incidents | 0 | 0 | ✓ |

---

## Next Epic Preview

**Epic 7: Audit & Compliance**

Зависимости от Epic 6:
- Per-route metrics labels (route_id, route_path) — готовы
- MetricsService pattern — можно переиспользовать для AuditService
- Dashboard layout — MetricsPage как образец для AuditLogPage

**Preparation needed:**
- Story 7.0: MetricsService → Prometheus HTTP API (CRITICAL)
- Аудит skipped тестов (HIGH)
- retro-actions.yaml setup (HIGH)

---

## Итог

Epic 6 доставлен с **100% completion rate**. Monitoring & Observability полностью реализован: Micrometer метрики, Prometheus scraping, Grafana dashboards, Admin UI виджеты, Theme Switcher.

**Ключевое открытие:** Action items из ретроспектив терялись из-за отсутствия трекинга — решено через retro-actions.yaml.

**Critical blocker для Epic 7:** MetricsService читает локальный MeterRegistry вместо Prometheus API — UI метрики не показывают реальные данные gateway-core.

---

*Сгенерировано в ходе Team Retrospective*
*Следующий шаг: Epic 7 — Audit & Compliance*
