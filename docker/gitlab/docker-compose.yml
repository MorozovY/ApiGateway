# GitLab CE + Runners + Nexus для локальной CI/CD инфраструктуры
# Документация: README.md в этой же директории
#
# Требования:
#   - RAM: 8GB минимум (GitLab 4GB + Nexus 2GB + Runners 2GB)
#   - Disk: 20GB+ для данных
#   - Ports: 8929, 8922, 5050, 8081 должны быть свободны
#
# Запуск: docker-compose up -d
# Первый запуск занимает 3-5 минут для инициализации GitLab
#
# После первого запуска:
#   1. Зарегистрировать runners: ./register-runners.sh
#   2. Настроить Nexus: http://localhost:8081 (admin/admin123)

services:
  gitlab:
    # Зафиксированная версия для стабильности (обновлять вручную)
    image: gitlab/gitlab-ce:latest
    container_name: gitlab
    hostname: gitlab.local
    restart: unless-stopped
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # Основной URL для GitLab Web UI
        external_url 'http://localhost:8929'

        # SSH порт для git clone/push
        gitlab_rails['gitlab_shell_ssh_port'] = 8922

        # Container Registry
        registry_external_url 'http://localhost:5050'
        registry['enable'] = true

        # Отключаем неиспользуемые сервисы для экономии ресурсов
        prometheus_monitoring['enable'] = false
        alertmanager['enable'] = false

        # Настройки производительности для локальной разработки
        puma['worker_processes'] = 2
        sidekiq['max_concurrency'] = 10
    ports:
      # HTTP (Web UI и API)
      - "8929:8929"
      # SSH (git clone/push по SSH)
      - "8922:22"
      # Container Registry
      - "5050:5050"
    volumes:
      # Конфигурация GitLab
      - gitlab_config:/etc/gitlab
      # Логи
      - gitlab_logs:/var/log/gitlab
      # Данные (репозитории, база данных, uploads)
      - gitlab_data:/var/opt/gitlab
    # Увеличиваем shared memory для PostgreSQL
    shm_size: '256m'
    # Healthcheck для мониторинга готовности
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8929/-/readiness"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 180s

  # =============================================================================
  # GITLAB RUNNERS (4 runners для параллельных jobs)
  # =============================================================================
  # Каждый runner может выполнять 1 job одновременно
  # 4 runners = до 4 параллельных jobs (backend-build, frontend-build, backend-test, frontend-test)

  gitlab-runner-1:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-runner-1
    restart: unless-stopped
    depends_on:
      gitlab:
        condition: service_healthy
    volumes:
      - runner_config_1:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
      # Shared caches для ускорения builds
      - gradle_cache:/cache/gradle
      - npm_cache:/cache/npm
    extra_hosts:
      - "gitlab.local:host-gateway"
      - "nexus:host-gateway"
    environment:
      # Указываем расположение shared caches
      GRADLE_USER_HOME: /cache/gradle
      NPM_CONFIG_CACHE: /cache/npm

  gitlab-runner-2:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-runner-2
    restart: unless-stopped
    depends_on:
      gitlab:
        condition: service_healthy
    volumes:
      - runner_config_2:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
      - gradle_cache:/cache/gradle
      - npm_cache:/cache/npm
    extra_hosts:
      - "gitlab.local:host-gateway"
      - "nexus:host-gateway"
    environment:
      GRADLE_USER_HOME: /cache/gradle
      NPM_CONFIG_CACHE: /cache/npm

  gitlab-runner-3:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-runner-3
    restart: unless-stopped
    depends_on:
      gitlab:
        condition: service_healthy
    volumes:
      - runner_config_3:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
      - gradle_cache:/cache/gradle
      - npm_cache:/cache/npm
    extra_hosts:
      - "gitlab.local:host-gateway"
      - "nexus:host-gateway"
    environment:
      GRADLE_USER_HOME: /cache/gradle
      NPM_CONFIG_CACHE: /cache/npm

  gitlab-runner-4:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-runner-4
    restart: unless-stopped
    depends_on:
      gitlab:
        condition: service_healthy
    volumes:
      - runner_config_4:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
      - gradle_cache:/cache/gradle
      - npm_cache:/cache/npm
    extra_hosts:
      - "gitlab.local:host-gateway"
      - "nexus:host-gateway"
    environment:
      GRADLE_USER_HOME: /cache/gradle
      NPM_CONFIG_CACHE: /cache/npm

  # =============================================================================
  # NEXUS REPOSITORY MANAGER (кэширование зависимостей)
  # =============================================================================
  # Проксирует Maven Central, npmjs.org для ускорения downloads
  # Web UI: http://localhost:8081
  # Default credentials: admin / admin123 (сменить после первого входа)

  nexus:
    image: sonatype/nexus3:3.68.0
    container_name: nexus
    restart: unless-stopped
    ports:
      - "8081:8081"   # Web UI и Maven/npm proxy
    volumes:
      - nexus_data:/nexus-data
    environment:
      # Уменьшаем memory footprint для локальной разработки
      INSTALL4J_ADD_VM_PARAMS: "-Xms512m -Xmx1g -XX:MaxDirectMemorySize=512m"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/service/rest/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

volumes:
  # Именованные volumes для персистентности данных
  # Данные сохраняются между docker-compose down/up

  # GitLab CE
  gitlab_config:
    name: gitlab_config
  gitlab_logs:
    name: gitlab_logs
  gitlab_data:
    name: gitlab_data

  # GitLab Runners (каждый runner имеет свой config)
  runner_config_1:
    name: gitlab_runner_config_1
  runner_config_2:
    name: gitlab_runner_config_2
  runner_config_3:
    name: gitlab_runner_config_3
  runner_config_4:
    name: gitlab_runner_config_4

  # Shared caches (все runners используют общий cache)
  gradle_cache:
    name: gitlab_gradle_cache
  npm_cache:
    name: gitlab_npm_cache

  # Nexus data
  nexus_data:
    name: nexus_data

networks:
  default:
    name: gitlab_network
